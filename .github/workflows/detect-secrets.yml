name: Secret Detection

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  detect-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Check for new secrets
        run: |
          # Scan current state
          detect-secrets scan --all-files \
            --exclude-files '\.git/.*' \
            --exclude-files '\.pytest_cache/.*' \
            --exclude-files '__pycache__/.*' \
            --exclude-files '\.mypy_cache/.*' \
            --exclude-files '\.tox/.*' \
            --exclude-files 'venv/.*' \
            --exclude-files '\.venv/.*' \
            --exclude-files 'node_modules/.*' \
            --exclude-files '.*\.egg-info/.*' \
            --exclude-files '\.secrets\.baseline' \
            --exclude-files '\.github/workflows/detect-secrets\.yml' \
            > scan_results.json

          if [ -f .secrets.baseline ]; then
            # Compare scan results against baseline
            python3 << 'EOF'
          import json
          import sys

          with open('scan_results.json') as f:
              current = json.load(f)
          with open('.secrets.baseline') as f:
              baseline = json.load(f)

          current_results = current.get('results', {})
          baseline_results = baseline.get('results', {})

          # Build set of known secrets (file:line:type:hash)
          known = set()
          for fname, secrets in baseline_results.items():
              for s in secrets:
                  known.add((fname, s.get('line_number'), s.get('type'), s.get('hashed_secret')))

          # Find new secrets not in baseline
          new_secrets = []
          for fname, secrets in current_results.items():
              for s in secrets:
                  key = (fname, s.get('line_number'), s.get('type'), s.get('hashed_secret'))
                  if key not in known:
                      new_secrets.append(f"{fname}:{s.get('line_number')} ({s.get('type')})")

          if new_secrets:
              print(f"::error::Found {len(new_secrets)} NEW secrets not in baseline!")
              for s in new_secrets:
                  print(f"  - {s}")
              sys.exit(1)
          else:
              baseline_count = sum(len(v) for v in baseline_results.values())
              print(f"No new secrets detected (baseline has {baseline_count} known entries)")
          EOF
          else
            # No baseline - check if any secrets found
            SECRETS_COUNT=$(python3 -c "import json; print(len(json.load(open('scan_results.json')).get('results', {})))")
            if [ "$SECRETS_COUNT" -eq 0 ]; then
              echo "No secrets detected"
            else
              echo "::error::Found secrets in $SECRETS_COUNT files! Create a .secrets.baseline to track known false positives."
              python3 -c "import json; print('\n'.join(json.load(open('scan_results.json')).get('results', {}).keys()))"
              exit 1
            fi
          fi
